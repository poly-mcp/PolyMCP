name: Publish Python Package (PolyMCP)

on:
  push:
    branches:
      - main
    paths:
      - 'polymcp/**'                          # Codice Python
      - 'pyproject.toml'                      # Config Python
      - 'MANIFEST.in'                         # IMPORTANTE per packaging
      - 'README.md'                           # Descrizione su PyPI
      - 'LICENSE'                             # Licenza del package
      - 'requirements.txt'                    # Se usato per dependencies
      - '.github/workflows/python-publish.yml' # Questo workflow
      - '!polymcp-ts/**'                     # IGNORA TypeScript
      - '!**/package.json'
      - '!**/*.ts'
      - '!**/*.js'

permissions:
  id-token: write
  contents: read

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade build twine toml

      - name: Generate version.py from pyproject.toml
        run: |
          python -c "
          import toml
          from pathlib import Path
          
          # Leggi pyproject.toml
          config = toml.load('pyproject.toml')
          version = config['project']['version']
          
          # Crea version.py
          version_file = Path('polymcp/version.py')
          version_file.write_text(f'__version__ = \"{version}\"\\n')
          
          print(f'✓ Generated polymcp/version.py with version {version}')
          print('Content:')
          print(version_file.read_text())
          "

      - name: Verify package structure
        run: |
          echo "=== Checking required files ==="
          test -f pyproject.toml && echo "✓ pyproject.toml" || (echo "✗ MISSING pyproject.toml" && exit 1)
          test -f README.md && echo "✓ README.md" || (echo "✗ MISSING README.md" && exit 1)
          test -d polymcp && echo "✓ polymcp/" || (echo "✗ MISSING polymcp/" && exit 1)
          test -f polymcp/__init__.py && echo "✓ polymcp/__init__.py" || (echo "✗ MISSING polymcp/__init__.py" && exit 1)
          test -f polymcp/version.py && echo "✓ polymcp/version.py (generated)" || (echo "✗ MISSING polymcp/version.py" && exit 1)

      - name: Clean previous builds
        run: |
          rm -rf dist/ build/ *.egg-info

      - name: Build package
        run: |
          python -m build
          echo ""
          echo "=== dist/ contents ==="
          ls -la dist/

      - name: Check metadata in wheel
        run: |
          echo "=== Extracting and checking METADATA ==="
          mkdir -p /tmp/wheel_test
          cd /tmp/wheel_test
          unzip -q $GITHUB_WORKSPACE/dist/*.whl
          echo "=== METADATA full content ==="
          cat *.dist-info/METADATA
          echo ""
          echo "=== Checking for Name and Version fields ==="
          grep -E "^(Name|Version):" *.dist-info/METADATA || (echo "❌ Name/Version fields NOT FOUND!" && exit 1)
          cd $GITHUB_WORKSPACE
          rm -rf /tmp/wheel_test

      - name: Check package with twine
        run: |
          echo "=== Running twine check ==="
          python -m twine check --strict dist/*

      - name: Test installation
        run: |
          pip install dist/*.whl
          python -c "import polymcp; print(f'✓ Package version: {polymcp.__version__}')"
          pip show polymcp

      - name: Publish to PyPI (via OIDC)
        if: success()
        uses: pypa/gh-action-pypi-publish@release/v1
